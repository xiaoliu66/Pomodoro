<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="shortcut icon" href="build/icon_256.ico" />
    <link rel="bookmark" href="build/icon_256.ico" />
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>番茄时钟</title>

    <script src="./node_modules/vue/dist/vue.js"></script>

    <!-- 引入样式 -->
    <link rel="stylesheet" href="./node_modules/element-ui/lib/theme-chalk/index.css">
    <!-- 引入组件库 -->
    <script src="./node_modules/element-ui/lib/index.js"></script>
</head>
<style>
    #time {
        font-size: 50px;
        font-family: 'Lucida Sans';
        text-align: center;
        margin-bottom: 20px;
    }

    #text {
        height: 20px;
        margin-top: 10px;
        font-size: 14px;
        color: cornflowerblue;
    }

    #app {
        text-align: center;
    }

    #btn {
        margin-bottom: 10px;
    }
</style>

<body>
    <div id="app">

        <div id='main'>
            <div style="margin-top: 20px;margin-bottom: 20px;">
                <el-radio-group v-model="radio2" size="medium" @change="switchClock()">
                    <el-radio-button label="25">25分钟</el-radio-button>
                    <el-radio-button label="30">30分钟</el-radio-button>
                    <el-radio-button label="40">40分钟</el-radio-button>
                    <el-radio-button label="50">50分钟</el-radio-button>
                </el-radio-group>
            </div>
        </div>

        <div id="time">
            {{time}}
            <div id='text'>
                {{clockInfo}}
            </div>
        </div>

        <div id="btn">
            <el-button type="primary" plain @click="status()" v-show='showBtn'>{{text}}</el-button>
            <el-button type="primary" @click="centerDialogVisible = true" v-show='showBtn'>自定义时间</el-button>
            <el-button type="primary" plain @click="endClock()">结束</el-button>
        </div>

        <div id="dialog">
            <el-dialog title="自定义时间" :visible.sync="centerDialogVisible" width="55%" center>
                <template>
                    <el-input-number v-model="hour" size="mini" controls-position="right" @change="handleChange"
                        :min="0" :max="24"></el-input-number>时
                    <el-input-number v-model="minutes" size="mini" controls-position="right" @change="handleChange"
                        :min="0" :max="60">小时</el-input-number>分
                    <el-input-number v-model="seconds" size="mini" controls-position="right" @change="handleChange"
                        :min="0" :max="60">小时</el-input-number>秒

                </template>

                <span slot="footer" class="dialog-footer">
                    <el-button @click="centerDialogVisible = false">取 消</el-button>
                    <el-button type="primary" @click="custom()">确 定</el-button>
                </span>
            </el-dialog>
        </div>

        <div id="showFinish">
            {{finishNum}}
        </div>
    </div>
</body>
<script>
    const {
        dialog
    } = require('electron').remote

    const db = require('./js/db.js');
    const time = require('./js/timeUtil.js');
    const sqlite3 = require("sqlite3");

    var clock;
    var breakClock;
    var numText = '';


    var fs = require('fs');
    var initSqlJs = require('./node_modules/sql.js/dist/sql-wasm.js');
    var filebuffer = fs.readFileSync('pomodoro.db');
    // db.dataBaseInit();


    let app = new Vue({
        el: '#app',
        data: {
            finishNum: '',
            hour: 0,
            minutes: 25,
            seconds: 0,
            defaultMinues: 1,
            time: '',
            text: '开始',
            isBegin: true, // 显示开始、暂停状态
            remainSeconds: 0, // 剩余时间 用于暂停功能
            radio2: 25, // 时间的默认值
            clockInfo: '', // 时钟状态信息
            breakTime: 1, // minutes
            showBtn: true, // 按钮显示状态
            clockStatus: '', // 番茄钟的状态 ‘work' 'break'
            centerDialogVisible: false,
            startTime: '', // 番茄钟开始时间
            endTime: '', // 番茄钟结束时间
            planTime: '' // 番茄钟预定时间
        },
        methods: {
            custom() {
                this.centerDialogVisible = false;
                this.time = this.start();
            },
            // 开始和暂停功能
            status() {
                if (this.text === '开始') {
                    this.startTime = time.timeStamp2String();
                    this.text = '暂停';
                    this.clockInfo = '进行中';
                    this.isBegin = true;
                    this.clockStatus = 'work';
                    let allSeconds = this.getAllSeconds();
                    // this.$message.success("开始时剩余时间：" + this.remainSeconds);
                    if (this.remainSeconds != 0) {
                        allSeconds = this.remainSeconds;
                    }
                    this.startClock(allSeconds);
                } else if (this.text === '暂停') {
                    this.text = '开始';
                    this.isBegin = false;
                }
            },
            // 倒计时
            startClock(allSeconds) {
                clock = window.setInterval(() => {
                    if (this.isBegin) {
                        allSeconds--;
                        this.time = this.getTime(this.clockStatus, allSeconds);

                        // 当预定时间到点时
                        if (allSeconds < 1) {
                            this.endTime = time.timeStamp2String();
                            window.clearInterval(clock);
                            this.text = '开始';
                            this.playNotify();
                            // 将番茄钟信息插入到数据库中
                            let planTime = this.hour + 'h' + this.minutes + 'm' + this.seconds + 's';
                            this.insertData(time.timeId(), this.startTime, this.endTime, planTime,
                                'true');
                            // 刷新番茄钟完成数据
                            this.getFinishNumber();
                            // 开始休息时间
                            this.startBreak(this.breakTime * 60);

                        }
                    } else {
                        window.clearInterval(clock);
                        this.remainSeconds = allSeconds;
                        // this.$message.success(this.remainSeconds+"");
                    }
                }, 1000)
            },
            // 休息时间
            startBreak(s) {
                this.clockStatus = 'break';
                this.clockInfo = '休息中';
                this.showBtn = false;
                breakClock = window.setInterval(() => {
                    s--;
                    this.time = this.getTime('break', s);

                    if (s < 1) {
                        this.time = this.start();
                        window.clearInterval(breakClock);
                        this.showBtn = true;
                        this.clockInfo = '';
                        // 调用系统的通知窗口
                        this.notify('番茄时钟', '您已经完成一个番茄时钟，请继续加油！');
                        this.clockStatus = '';
                    }
                }, 1000)
            },
            // 初始化
            start() {
                let ahour = this.hour;
                let aminutes = this.minutes;
                let aseconds = this.seconds;

                if (ahour < 10) {
                    ahour = '0' + ahour;
                }

                if (aminutes < 10) {
                    aminutes = '0' + aminutes;
                }

                if (aseconds < 10) {
                    aseconds = '0' + aseconds;
                }

                if (this.hour != 0) {
                    return ahour + ":" + aminutes + ":" + aseconds;
                } else {
                    return aminutes + ":" + aseconds;
                }

            },
            // 结束番茄钟
            endClock() {
                if (this.clockStatus === 'work') {
                    dialog.showMessageBox({
                        type: 'warning',
                        title: '警告',
                        message: '现在番茄钟正在运行，确定要结束吗？',
                        buttons: ['确定', '取消']
                    }).then(result => {
                        // this.$message.success(""+result.response)
                        // 根据buttons中按钮组中的索引值来判断
                        if (result.response == 0) {
                            window.clearInterval(clock);
                            this.endTime = time.timeStamp2String();
                            this.time = this.start();
                            this.remainSeconds = 0;
                            this.text = '开始';
                            this.clockInfo = '';

                            // 在运行中的番茄钟结束，就相当于失败了。把失败的数据插入到数据库中。
                            let planTime = this.hour + 'h' + this.minutes + 'm' + this.seconds + 's';
                            this.insertData(time.timeId(), this.startTime, this.endTime, planTime,'false')
                        }
                    })
                } else if (this.clockStatus === 'break') {
                    dialog.showMessageBox({
                        type: 'warning',
                        title: '警告',
                        message: '现在是休息时间，确定要结束吗？',
                        buttons: ['确定', '取消']
                    }).then(result => {
                        // this.$message.success(""+result.response)
                        // 根据buttons中按钮组中的索引值来判断
                        if (result.response == 0) {
                            this.time = this.start();
                            window.clearInterval(breakClock);
                            this.showBtn = true;
                            this.clockInfo = '';
                            // 调用系统的通知窗口
                            this.notify('番茄时钟', '您已经完成一个番茄时钟，请继续加油！');
                            this.clockStatus = '';
                        }
                    })
                }

            },
            // 选择时间
            switchClock() {
                this.minutes = this.radio2;
                this.time = this.start();
            },
            // 时间结束后播放提示音
            playNotify() {
                let audio = new Audio()
                audio.src = "./sound/1.wav";
                audio.play();
            },
            getAllSeconds() {
                return this.hour * 3600 + this.minutes * 60 + this.seconds
            },
            getHour(seconds) {
                return Math.floor(seconds / 3600);
            },
            getMinutes(seconds) {
                return Math.floor((seconds - this.getHour(seconds) * 3600) / 60);
            },
            getSeconds(seconds) {
                return Math.floor(seconds - this.getHour(seconds) * 3600 - this.getMinutes(seconds) * 60);
            },
            // 给定总秒数返回特定格式的时间字符串 00:00:00
            getTime(status, s) {
                if (status === 'work') {
                    let hour = this.getHour(s);
                    let minutes = this.getMinutes(s);
                    let seconds = this.getSeconds(s);

                    let ahour = hour;
                    let aminutes = minutes;
                    let aseconds = seconds;

                    if (hour < 10) {
                        ahour = '0' + ahour;
                    }

                    if (minutes < 10) {
                        aminutes = '0' + aminutes;
                    }

                    if (seconds < 10) {
                        aseconds = '0' + aseconds;
                    }

                    if (hour == 0) {
                        return aminutes + ":" + aseconds;
                    } else {
                        return ahour + ":" + aminutes + ":" + aseconds;
                    }
                } else if (status === 'break') {
                    let minutes = this.getMinutes(s);
                    let seconds = this.getSeconds(s);

                    let aminutes = minutes;
                    let aseconds = seconds;

                    if (minutes < 10) {
                        aminutes = '0' + aminutes;
                    }

                    if (seconds < 10) {
                        aseconds = '0' + aseconds;
                    }

                    let result = aminutes + ":" + aseconds;

                    return result;
                }

            },
            // 调用系统通知
            notify(title, body) {
                var option = {
                    title: title,
                    body: body
                }
                new window.Notification(option.title, option)
            },
            handleChange(value) {
                // console.log(value);
            },
            // 查询当天完成番茄钟的个数
            async getFinishNumber() {
                // 同步执行
                await initSqlJs().then(function (SQL) {
                    // Load the db
                    var dbs = new SQL.Database(filebuffer);
                    // Prepare an sql statement
                    var stmt = dbs.prepare(
                        "select count(*) n from pomodoro_list where isFinished='true' and id like '" +
                        time.getToday() + "%'"
                    );

                    // Bind values to the parameters and fetch the results of the query
                    var result = stmt.getAsObject({
                        n: ''
                    });

                    let num = result.n;
                    console.log(num)
                    if (num > 0) {
                        numText = '您今天一共完成了' + num + '个番茄钟，请继续加油！';
                    } else {
                        numText = '您今天还没有完成的番茄钟，快去创建吧！'
                    }
                    dbs.close();
                })

                this.finishNum = numText;
                console.log(new Date().getTime() + "-" + this.finishNum);
            },
            insertData(id, startTime, endTime, planTime, isFinished) {
                // 同步执行
                initSqlJs().then(function (SQL) {

                    var dbs = new SQL.Database(filebuffer);
                    dbs.run("BEGIN TRANSACTION;")
                    dbs.run("insert into pomodoro_list(id, startTime, endTime, planTime, isFinished) VALUES(:id, :startTime, :endTime, :planTime, :isFinished)", {
                        ':id': id,
                        ':startTime': startTime,
                        ':endTime': endTime,
                        ':planTime': planTime,
                        ':isFinished': isFinished
                    })
                    dbs.run("COMMIT TRANSACTION;")

                    // 以下的代码必须要有，否则只是在内存中插入，并没有将数据写入到文件中。
                    var data = dbs.export();
                    var buffer = Buffer.from(data, 'binary');
                    // 被创建数据库名称
                    var filename = "pomodoro.db";
                    fs.writeFileSync(filename, buffer);
                    dbs.close();
                })
            }
        },
        created() {
            // 将显示文字重置为初始值
            this.time = this.start();

        },
        mounted() {
            this.getFinishNumber();
        }
    });

    // 关闭所有窗口
    window.onbeforeunload = function (e) {
        // console.log('I do not want to be closed')
        if (app.clockStatus == 'work') {
            app.endTime = time.timeStamp2String();
            // 将番茄钟信息插入到数据库中
            let planTime = app.hour + 'h' + app.minutes + 'm' + app.seconds + 's';
            db.insertData(time.timeId(), app.$data.startTime, app.$data.endTime, planTime, 'false');

            e.preventDefault();
        }

    };

    // 查询
    // var getFinishNum = function () {
    //     let databases = new sqlite3.Database("./pomodoro.db", function (err) {
    //         //插入数据
    //         let selectSql =
    //             "select count(*) n from pomodoro_list where isFinished='true' and id like" + "'" + time
    //             .getToday() + "%'";
    //         // get功能：运行指定参数的SQL语句，完成过后调用回调函数。如果执行成功，则回调函数中的第一个参数为null,第二个参数为结果集中的第一行数据，反之则回调函数中只有一个参数，只参数为一个错误的对象。
    //         databases.get(selectSql, function (err, rows) {
    //             if (err) {
    //                 console.log("select from pomodoro_list error,", err
    //                     .message);
    //             } else {
    //                 if (rows.n > 0) {
    //                     app.finishNum = '您今天一共完成了' + rows.n + '个番茄钟，请继续加油！';
    //                 } else {
    //                     app.finishNum = '您今天还没有完成的番茄钟，快去创建吧！'
    //                 }

    //             }
    //         });
    //     });
    // }
</script>

</html>